import json
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

import os
CAPITAL_API_KEY = os.getenv("CAPITAL_API_KEY")
BASE_URL = "https://api-capital.backend-capital.com"

def get_auth_token():
    headers = {"X-CAP-API-KEY": CAPITAL_API_KEY}
    resp = requests.post(BASE_URL + "/api/v1/session", headers=headers)
    return resp.headers.get("X-SECURITY-TOKEN"), resp.cookies

def place_market_order(signal, symbol, lot_size):
    token, cookies = get_auth_token()
    headers = {
        "X-CAP-API-KEY": CAPITAL_API_KEY,
        "X-SECURITY-TOKEN": token,
        "Content-Type": "application/json"
    }

    direction = "BUY" if signal == "LONG" else "SELL"

    order_payload = {
        "marketId": symbol,
        "direction": direction,
        "size": lot_size,
        "orderType": "MARKET",
        "currencyCode": "USD",
        "forceOpen": True,
        "guaranteedStop": False
    }

    response = requests.post(BASE_URL + "/api/v1/positions", headers=headers, cookies=cookies, json=order_payload)
    return response.json()

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    print(f"Received alert: {data}")

    if "signal" in data and "symbol" in data and "lot_size" in data:
        try:
            result = place_market_order(data["signal"], data["symbol"], data["lot_size"])
            return jsonify({"status": "success", "details": result}), 200
        except Exception as e:
            return jsonify({"status": "error", "message": str(e)}), 500
    else:
        return jsonify({"status": "error", "message": "Missing required fields"}), 400

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
